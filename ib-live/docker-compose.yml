version: '3.8'

services:
  mcp-ib-live:
    build:
      context: ../ib
      dockerfile: Dockerfile
    container_name: mcp-ib-live
    restart: unless-stopped
    env_file:
      - $HOME/secrets/mcp-ib-live.env
    environment:
      IB_HOST: ibgateway-live
      # NOTE: Currently set to 4004 (paper) for testing
      # Change to 4003 when ready for live trading
      IB_PORT: 4004
      IB_CLIENT_ID: 10  # Different client ID to avoid conflicts
      IB_POOL_SIZE: 3
      MCP_SERVER_NAME: ib-live
    ports:
      - "48014:8000"
    depends_on:
      - mcp-ib-gateway-live
    networks:
      - mcp-ib-live-net
      - mcp-net
      - traefik-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  mcp-ib-gateway-live:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: mcp-ib-gateway-live
    restart: unless-stopped
    env_file:
      - $HOME/secrets/mcp-ib-live.env
    environment:
      TWS_USERID: ${IB_USERNAME}
      TWS_PASSWORD: ${IB_PASSWORD}
      # NOTE: Currently set to paper for testing
      # Change to live when ready for live trading
      TRADING_MODE: paper
      READ_ONLY_API: ${READ_ONLY_API:-no}
      VNC_SERVER_PASSWORD: ${VNC_SERVER_PASSWORD:-}
      TWOFA_TIMEOUT_ACTION: restart
    ports:
      - "14011:4003"   # Live trading API via socat
      - "14012:4004"   # Paper trading API via socat
      - "15901:5900"   # VNC
    volumes:
      - ./jts:/root/Jts
      - ./ibc:/root/ibc
    networks:
      mcp-ib-live-net:
        aliases:
          - ibgateway-live

networks:
  mcp-ib-live-net:
    name: mcp-ib-live-net
  mcp-net:
    external: true
  traefik-net:
    external: true

version: '3.8'

services:
  mcp-ib:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-ib
    restart: unless-stopped
    env_file:
      - $HOME/projects/secrets/mcp-ib.env
    environment:
      IB_HOST: ${IB_HOST:-mcp-ib-gateway}
      IB_PORT: ${IB_PORT:-4002}
      IB_CLIENT_ID: ${IB_CLIENT_ID:-1}
      MCP_SERVER_NAME: ib
    ports:
      - "48012:8000"
    depends_on:
      - mcp-ib-gateway
    networks:
      - mcp-ib-net
      - mcp-net
      - traefik-net
    volumes:
      - ./config:/app/config
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=5).close()"]
      interval: 30s
      timeout: 5s
      retries: 3

  mcp-ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: mcp-ib-gateway
    restart: unless-stopped
    env_file:
      - $HOME/projects/secrets/mcp-ib.env
    environment:
      TWS_USERID: ${IB_USERNAME}
      TWS_PASSWORD: ${IB_PASSWORD}
      TRADING_MODE: ${TRADING_MODE:-paper}
      READ_ONLY_API: ${READ_ONLY_API:-no}
      VNC_SERVER_PASSWORD: ${VNC_SERVER_PASSWORD:-}
      TWOFA_TIMEOUT_ACTION: ${TWOFA_TIMEOUT_ACTION:-restart}
    ports:
      - "14001:4003"   # Live trading API via socat (IB Gateway listens on 127.0.0.1:4001)
      - "14002:4004"   # Paper trading API via socat (IB Gateway listens on 127.0.0.1:4002)
      - "15900:5900"
    volumes:
      - ./jts:/root/Jts
      - ./ibc:/root/ibc
    networks:
      mcp-ib-net:
        aliases:
          - ibgateway

networks:
  mcp-ib-net:
    name: mcp-ib-net
    external: false
  mcp-net:
    name: mcp-net
    external: true
  traefik-net:
    name: traefik-net
    external: true

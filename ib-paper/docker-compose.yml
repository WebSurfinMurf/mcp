version: '3.8'

services:
  mcp-ib-paper:
    build:
      context: ../ib
      dockerfile: Dockerfile
    container_name: mcp-ib-paper
    restart: unless-stopped
    env_file:
      - $HOME/projects/secrets/mcp-ib-paper.env
    environment:
      IB_HOST: ibgateway-paper
      IB_PORT: 4004  # Paper trading via socat
      IB_CLIENT_ID: 1
      IB_POOL_SIZE: 3
      MCP_SERVER_NAME: ib-paper
      GATEWAY_CONTAINER: mcp-ib-gateway-paper
    ports:
      - "48012:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - mcp-ib-gateway-paper
    networks:
      - mcp-ib-paper-net
      - mcp-net
      - traefik-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  mcp-ib-gateway-paper:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: mcp-ib-gateway-paper
    restart: unless-stopped
    env_file:
      - $HOME/projects/secrets/mcp-ib-paper.env
    environment:
      # TWS_USERID and TWS_PASSWORD come from env_file
      API_PORT: 4002        # Port IB Gateway actually listens on (must match UI)
      SOCAT_PORT: 4004      # Port socat listens on (exposed)
    ports:
      - "14001:4003"   # Live trading API via socat
      - "14002:4004"   # Paper trading API via socat
      - "15900:5900"   # VNC
    volumes:
      - ./config/config.ini.tmpl:/home/ibgateway/ibc/config.ini.tmpl:ro
      - ./config/run_socat.sh:/home/ibgateway/scripts/run_socat.sh:ro
      # NOTE: Cannot mount Jts directory - would override required template files
      # ibg.xml is encrypted and requires manual VNC config after each restart
    networks:
      mcp-ib-paper-net:
        aliases:
          - ibgateway-paper

networks:
  mcp-ib-paper-net:
    name: mcp-ib-paper-net
  mcp-net:
    external: true
  traefik-net:
    external: true
